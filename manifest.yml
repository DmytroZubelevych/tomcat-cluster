type: update                                                                                                                                                                                                                    
version: 1.6.1                                                                                                                                                                                                                  
id: tomcat_cluster                                                                                                                                                                                                              
baseUrl: https://raw.githubusercontent.com/SiryjVyiko/tomcat-cluster/master                                                                                                                                            
description:                                                                                                                                                                                                                     
  short: Tomcat Cluster Logic (Beta)                                                                                                                                                                                                                                 
name: Tomcat Cluster Logic

nodeGroupAlias:
  ${settings.nodeGroup}: cp
                                                                                                                                                                              
onInstall:
  - cmd[${this:cp}]: yum -y install xmlstarlet; sed -i '/<\/Host>/e curl ${baseUrl}/conf/cluster.tpl' /opt/tomcat/conf/server.xml
    user: root
  - forEach(wnode:nodes.cp):
      - cmd[${@wnode.id}]: sed -i "s/defaultHost=\"localhost\"/defaultHost=\"${@wnode.intIP}\"/g" /opt/tomcat/conf/server.xml; sed -i "s/Host[[:space:]]*name=\"localhost\"/Host name=\"${@wnode.intIP}\"/g" /opt/tomcat/conf/server.xml
        user: root
      - forEach(clnode:nodes.cp):
          - cmd[${@wnode.id}]: MEMBER_ID=${echo ${@clnode.intIP} | sed 's/\./,/g'}; sed -i "/<\/Membership>/i \<Member className=\"org.apache.catalina.tribes.membership.StaticMember\" port=\"4004\" host=\"${@clnode.intIP}\" uniqueId=\"{0,1,2,3,4,5,6,7,8,9,10,11,${MEMBER_ID}}\" \/>" /opt/tomcat/conf/server.xml 
            user: root
